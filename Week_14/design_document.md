# 秒杀系统需求分析

## 业务特点

- 瞬时并发量大
- 库存有限
- 业务简单

## 技术挑战

- 对现有业务系统造成冲击
- 高并发下对应用和数据库的负载急剧增大
- 网络和服务器带宽突然增大
- 链接暴露直接下单
- 高并发下的数据安全保障

# 数据库设计

涉及到商品详情，订单，库存等模块的库表设计。

## 保证数据可用性

# 技术选型调研与架构设计

## 技术选型调研

秒杀里用到的基础组件，有服务器框架，缓存中间件，关系型数据库，MQ.

根据团队的技术栈，选择Tomcat Web容器，高性能Redis缓存，MySQL,Kafka或者RocketMQ.

## 架构设计

根据经验，将请求拦截在系统上游,读缓存写异步。

### 单机Tomcat服务器容量和优化

压测Tomcat服务器线程容量问题，合理的配置等待队列长度，最大最小工作线程，使得单机服务器性能最优

### 多级缓存和优化

1. Redis缓存商品详情
2. Guava热点数据缓存
3. 使用Nginx lua脚本缓存

### 页面静态化

1. 使用CDN，缓存静态资源到CDN服务器上。
2. 全页面静态化，使得用户请求页面时直接得到一个已经渲染好的HTML页面。

### 缓存库存

1. 交易验证优化，把对用户，商品，活动的查询信息进行缓存
2. 添加索引从锁表变为锁行
3. 减库存，先从缓存中扣，再从数据库中扣，引入消息中间件

### 事务型消息

根据业务特征选择合适的异步消息发送时机，一般需要在事务提交后再发送事务型消息异步操作，保证数据的一致性。

### 流量削峰

1. 利用秒杀令牌，使校验逻辑和下单逻辑分离。
2. 设定令牌总量
3. 封装固定大小的线程池，一次只处理固定大小的请求

### 防刷限流

1. 采用验证码技术，在发送秒杀令牌之前，再限流
2. 设备指纹，凭证系统方式防刷